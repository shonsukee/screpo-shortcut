{% extends "layout.html" %}

{% block content %}
<div class="container">
    <h1 class="title">ã‚¹ã‚¯ãƒ¬ãƒå…¥åŠ›</h1>
    <div class="wrap">
        <a href="/"><button type="button" id="toggle_button">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button></a>
    </div>

    {% if data and data['students'] | length > 0 %}
        <div class="students_wrap">
            {% for student in data["students"] %}
                <form action="/register" method="post">
                    <div class="content">
                        <div class="student_name">
                            <label for="student_{{ student.index }}">{{student.class_start_time}}ã€œã€{{ student.subject }}ã€‘{{ student.name }}</label>
                        </div>
                        <button type="submit" class="register_button">ç™»éŒ²</button>
                    </div>

                    <textarea
                        name="content_{{ student.index }}"
                        class="student_comment"
                        id="content_{{ student.index }}"
                        cols="30"
                        rows="5"
                        placeholder="ã‚¹ã‚¯ãƒ¬ãƒã‚’å…¥åŠ›"
                        oninput="saveText(this.id, this.value)"
                    ></textarea>
                    <input type="hidden" name="students" value="{{ data['students'] }}">
                    <input type="hidden" name="index" value="{{ student.index }}">
                    <input type="hidden" name="user_id" value="{{ user_id }}">
                    <input type="hidden" name="key1" value="{{ student.key1 }}">
                    <input type="hidden" name="key2" value="{{ student.key2 }}">
                    <input type="hidden" name="key3" value="{{ student.key3 }}">
                </form>
            {% endfor %}
        </div>
    {% elif error %}
        <div class="no_student_wrap">
            <p class="no_student" style="color: #9B003F;">{{ error | safe }}</p>
        </div>
    {% else %}
        <div class="no_student_wrap">
            <p class="no_student" style="color:#1f2c5c;">æˆæ¥­ã¯ã‚ã‚Šã¾ã›ã‚“ğŸ’¤</p>
        </div>
    {% endif %}
</div>

<script>
    // æ—¥ä»˜ãŒå¤‰ã‚ã‚‹ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’åˆæœŸåŒ–
    window.addEventListener("load", function() {
        const today = new Date().toLocaleDateString();
        const lastAccessDate = localStorage.getItem("last_access_date");

        if (!lastAccessDate || lastAccessDate !== today) {
            const user_id = localStorage.getItem("user_id");
            localStorage.clear();

            if (user_id) {
                localStorage.setItem("user_id", user_id);
            }
            localStorage.setItem("last_access_date", today);
        }
    });

    // æœªç™»éŒ²ã®ã‚¹ã‚¯ãƒ¬ãƒã‚’ä¸€æ™‚ä¿å­˜
    function saveText(student_id, text) {
        localStorage.setItem(student_id, text);
    }

    // ã‚¹ã‚¯ãƒ¬ãƒã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«æ ¼ç´
    window.addEventListener("load", function() {
        const students = JSON.parse('{{ data["students"] | tojson | safe }}');
        students.forEach(student => {
            const student_id = "content_" + student.index;

            let content = "";
            // ç™»éŒ²æ¸ˆã¿ã®å ´åˆ
            if (student.content) {
                content = student.content;
                localStorage.setItem(student_id, content);
            }
            // æœªç™»éŒ²ã®å ´åˆ
            else {
                content = localStorage.getItem(student_id);
            }

            document.getElementById(student_id).value = content;
        });
    });
</script>
{% endblock %}