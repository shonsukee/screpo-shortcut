{% extends "layout.html" %}

{% block content %}
<div class="container">
    <h1 class="title">ã‚¹ã‚¯ãƒ¬ãƒå…¥åŠ›</h1>
    <div class="wrap">
        <a href="/"><button type="button" id="toggle_button">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button></a>
    </div>

    {% if data and data['students'] | length > 0 %}
        <div class="students_wrap">
            {% for student in data["students"] %}
                <form action="/register" method="post">
                    <!-- ç”Ÿå¾’æƒ…å ± -->
                    <div class="content">
                        <div class="student_name">
                            <label for="student_{{ student.index }}">{{student.class_start_time}}ã€œã€{{ student.subject }}ã€‘{{ student.name }}</label>
                        </div>
                        <button type="submit" class="register_button">ç™»éŒ²</button>
                    </div>

                    <!-- ã‚¹ã‚¯ãƒ¬ãƒå…¥åŠ›æ¬„ -->
                    <textarea
                        name="content_{{ student.index }}"
                        class="student_comment"
                        id="content_{{ student.index }}"
                        cols="30"
                        rows="5"
                        placeholder="ã‚¹ã‚¯ãƒ¬ãƒã‚’å…¥åŠ›"
                        oninput="saveInfo(this.id, this.value)"
                    ></textarea>

                    <!-- è¿½åŠ æƒ…å ±ã®ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
                    <button type="button" class="slider-btn" onclick="sliderDetails('{{ student.index }}')">
                        â–¶ï¸ è¿½åŠ æƒ…å ±
                    </button>

                    <!-- è¿½åŠ æƒ…å ± -->
                    <div id="student_details_{{ student.index }}" hidden>
                        <!-- é…åˆ»æƒ…å ± -->
                        <div class="slider-container">
                            <span class="detail_span" id="late_value">é…åˆ»ã€ç„¡ã€‘</span>
                            <input type="range" name="late" id="late_{{ student.index }}" min="0" max="1" list="late_list" oninput="saveInfo(this.id, this.value)" onchange="saveInfo(this.id, this.value)">
                            <datalist id="late_list">
                                <option value="0"></option>
                                <option value="1"></option>
                            </datalist>
                        </div>
                        <!-- å‰å›ã®å®¿é¡Œæƒ…å ± -->
                        <div class="slider-container">
                            <span class="detail_span" id="homework_value">å®¿é¡Œã€OKã€‘</span>
                            <input type="range" name="homework" id="homework_{{ student.index }}" min="0" max="3" step="1" list="homework_list" oninput="saveInfo(this.id, this.value)" onchange="saveInfo(this.id, this.value)">
                            <datalist id="homework_list">
                                <option value="0"></option>
                                <option value="1"></option>
                                <option value="2"></option>
                                <option value="3"></option>
                            </datalist>
                        </div>
                        <!-- æˆæ¥­ä¸­ã®é›†ä¸­åŠ›æƒ…å ± -->
                        <div class="slider-container">
                            <span class="detail_span" id="concentration_value">é›†ä¸­åŠ›ã€æ™®é€šã€‘</span>
                            <input type="range" name="concentration" id="concentration_{{ student.index }}" min="0" max="4" step="1" list="concentration_list" oninput="saveInfo(this.id, this.value)" onchange="saveInfo(this.id, this.value)">
                            <datalist id="concentration_list">
                                <option value="0"></option>
                                <option value="1"></option>
                                <option value="2"></option>
                                <option value="3"></option>
                                <option value="4"></option>
                            </datalist>
                        </div>
                        <!-- æˆæ¥­ä¸­ã®ç†è§£åº¦æƒ…å ± -->
                        <div class="slider-container">
                            <span class="detail_span" id="understanding_value">ç†è§£åº¦ã€æ™®é€šã€‘</span>
                            <input type="range" name="understanding" id="understanding_{{ student.index }}" min="0" max="4" step="1" list="understanding_list" oninput="saveInfo(this.id, this.value)" onchange="saveInfo(this.id, this.value)">
                            <datalist id="understanding_list">
                                <option value="0"></option>
                                <option value="1"></option>
                                <option value="2"></option>
                                <option value="3"></option>
                                <option value="4"></option>
                            </datalist>
                        </div>
                        <!-- æœ¬æ—¥ã®å®¿é¡Œæƒ…å ± -->
                        <div class="slider-container">
                            <span class="detail_span" id="today_homework_value">æœ¬æ—¥ã®å®¿é¡Œã€æœ‰ã€‘</span>
                            <input type="range" name="today_homework" id="today_homework_{{ student.index }}" min="0" max="1" step="1" list="today_homework_list" oninput="saveInfo(this.id, this.value)" onchange="saveInfo(this.id, this.value)">
                            <datalist id="today_homework_list">
                                <option value="0"></option>
                                <option value="1"></option>
                            </datalist>
                        </div>
                    </div>

                    <input type="hidden" name="students" value="{{ data['students'] }}">
                    <input type="hidden" name="index" value="{{ student.index }}">
                    <input type="hidden" name="user_id" value="{{ user_id }}">
                    <input type="hidden" name="key1" value="{{ student.key1 }}">
                    <input type="hidden" name="key2" value="{{ student.key2 }}">
                    <input type="hidden" name="key3" value="{{ student.key3 }}">
                </form>
            {% endfor %}
        </div>
    {% elif error %}
        <div class="no_student_wrap">
            <p class="no_student" style="color: #9B003F;">{{ error | safe }}</p>
        </div>
    {% else %}
        <div class="no_student_wrap">
            <p class="no_student" style="color:#1f2c5c;">æˆæ¥­ã¯ã‚ã‚Šã¾ã›ã‚“ğŸ’¤</p>
        </div>
    {% endif %}
</div>

<script>
    // æ—¥ä»˜ãŒå¤‰ã‚ã‚‹ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’åˆæœŸåŒ–
    window.addEventListener("load", function() {
        const today = new Date().toLocaleDateString();
        const lastAccessDate = localStorage.getItem("last_access_date");

        if (!lastAccessDate || lastAccessDate !== today) {
            const user_id = localStorage.getItem("user_id");
            localStorage.clear();

            if (user_id) {
                localStorage.setItem("user_id", user_id);
            }
            localStorage.setItem("last_access_date", today);
        }
    });

    // æœªç™»éŒ²ã®ã‚¹ã‚¯ãƒ¬ãƒã‚’ä¸€æ™‚ä¿å­˜
    function saveInfo(student_id, text) {
        localStorage.setItem(student_id, text);
    }

    // æ—¢å­˜ã‚¢ãƒ—ãƒªã‹ã‚‰å–å¾—ã—ãŸã‚¹ã‚¯ãƒ¬ãƒã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«æ ¼ç´
    window.addEventListener("load", function() {
        const students = JSON.parse('{{ data["students"] | tojson | safe }}');
        students.forEach(student => {
            const student_id = "content_" + student.index;

            let content = "";
            // ç™»éŒ²æ¸ˆã¿ã®å ´åˆ
            if (student.content) {
                content = student.content;
                localStorage.setItem(student_id, content);
            }
            // æœªç™»éŒ²ã®å ´åˆ
            else {
                content = localStorage.getItem(student_id);
            }

            document.getElementById(student_id).value = content;

            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å€¤ã«è¨­å®š
            const late_id = "late_" + student.index;
            const homework_id = "homework_" + student.index;
            const concentration_id = "concentration_" + student.index;
            const understanding_id = "understanding_" + student.index;
            const today_homework_id = "today_homework_" + student.index;

            document.getElementById(late_id).value = localStorage.getItem(late_id) || 0;
            document.getElementById(homework_id).value = localStorage.getItem(homework_id) || 3;
            document.getElementById(concentration_id).value = localStorage.getItem(concentration_id) || 2;
            document.getElementById(understanding_id).value = localStorage.getItem(understanding_id) || 2;
            document.getElementById(today_homework_id).value = localStorage.getItem(today_homework_id) || 1;
        });
    });

    // è¿½åŠ æƒ…å ±ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤º
    function sliderDetails(index) {
        const details = document.getElementById("student_details_" + index);
        const button = event.target;

        if (details.hidden) {
            details.hidden = false;
            button.textContent = "â–¼ è¿½åŠ æƒ…å ±";
        } else {
            details.hidden = true;
            button.textContent = "â–¶ï¸ è¿½åŠ æƒ…å ±";
        }
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
    function changeMessageStatus(values, slider_id, value_id) {
        const slider = document.getElementById(slider_id);
        const value = document.getElementById(value_id);
        value.textContent = values[slider.value];
        slider.addEventListener("input", function() {
            value.textContent = values[this.value];
        });
    }

    // å¤‰æ›´ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    window.addEventListener("load", function() {
        const late_values = ["é…åˆ»ã€ç„¡ã€‘", "é…åˆ»ã€æœ‰ã€‘"];
        changeMessageStatus(late_values, "late_slider", "late_value");

        const homework = ["å®¿é¡Œã€ç„¡ã€‘", "å®¿é¡Œã€å¿˜ã€‘", "å®¿é¡Œã€ä¸€éƒ¨ä¸å‚™ã€‘", "å®¿é¡Œã€OKã€‘"];
        changeMessageStatus(homework, "homework_slider", "homework_value");

        const concentration = ["é›†ä¸­åŠ›ã€æœ€æ‚ªã€‘", "é›†ä¸­åŠ›ã€æ‚ªã„ã€‘", "é›†ä¸­åŠ›ã€æ™®é€šã€‘", "é›†ä¸­åŠ›ã€è‰¯ã„ã€‘", "é›†ä¸­åŠ›ã€æœ€è‰¯ã€‘"];
        changeMessageStatus(concentration, "concentration_slider", "concentration_value");

        const understanding = ["ç†è§£åº¦ã€æœ€æ‚ªã€‘", "ç†è§£åº¦ã€æ‚ªã„ã€‘", "ç†è§£åº¦ã€æ™®é€šã€‘", "ç†è§£åº¦ã€è‰¯ã„ã€‘", "ç†è§£åº¦ã€æœ€è‰¯ã€‘"];
        changeMessageStatus(understanding, "understanding_slider", "understanding_value");

        const today_homework = ["æœ¬æ—¥ã®å®¿é¡Œã€ç„¡ã€‘", "æœ¬æ—¥ã®å®¿é¡Œã€æœ‰ã€‘"];
        changeMessageStatus(today_homework, "today_homework_slider", "today_homework_value");
    });
</script>
{% endblock %}